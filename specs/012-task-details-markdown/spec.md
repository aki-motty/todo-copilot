# Feature Specification: タスク詳細のマークダウン編集機能

**Feature Branch**: `012-task-details-markdown`  
**Created**: 2025-11-30  
**Status**: Draft  
**Input**: User description: "タスクに対して詳細を追加できるようにしたいです。詳細はマークダウン形式で編集できるようにしたいです。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - タスク詳細の追加・編集 (Priority: P1)

ユーザーとして、タスクに詳細な説明を追加したい。これにより、タスクの背景情報、手順、参考リンクなどを記録でき、後で見返したときに何をすべきか明確に理解できる。

**Why this priority**: タスク管理において、タイトルだけでは伝えきれない情報を記録することは基本的なニーズ。これがなければ詳細機能として価値を提供できない。

**Independent Test**: タスクを選択し、詳細を入力・保存できることを確認。保存後にページをリロードしても詳細が保持されていることで検証可能。

**Acceptance Scenarios**:

1. **Given** 既存のタスクがある, **When** ユーザーがタスクの詳細入力エリアをクリックする, **Then** 詳細パネルが開き、詳細を入力できる編集モードになる
2. **Given** 詳細編集モードになっている, **When** ユーザーがテキストを入力し保存ボタンをクリックする, **Then** 詳細が保存され表示される
3. **Given** 詳細が保存されている, **When** ページをリロードする, **Then** 詳細が保持されて表示される
4. **Given** 既存の詳細がある, **When** ユーザーが詳細を編集し保存ボタンをクリックする, **Then** 変更内容が保存される
5. **Given** 詳細パネルが開いている, **When** ユーザーがパネル外をクリックまたは閉じるボタンをクリックする, **Then** 詳細パネルが閉じる
6. **Given** 詳細を編集中（未保存の変更あり）, **When** ユーザーが保存せずにパネルを閉じようとする, **Then** 未保存の変更がある旨の警告が表示される

---

### User Story 2 - マークダウンプレビュー (Priority: P2)

ユーザーとして、入力したマークダウンがどのように表示されるかをプレビューで確認したい。これにより、意図した通りの書式で表示されるか事前に確認できる。

**Why this priority**: マークダウン形式での入力を可能にするため、プレビュー機能は使いやすさに直結する。ただし、プレーンテキストでも最低限の価値は提供できるため、P1より優先度は低い。

**Independent Test**: 編集モードでマークダウン記法を入力し、プレビュー表示に切り替えたときに正しくレンダリングされることを確認。

**Acceptance Scenarios**:

1. **Given** 詳細編集モードである, **When** ユーザーがプレビューボタンをクリックする, **Then** マークダウンがレンダリングされた状態で表示される
2. **Given** プレビューモードである, **When** ユーザーが編集ボタンをクリックする, **Then** 再び編集モードに戻る
3. **Given** 詳細が保存されている, **When** タスク一覧で詳細を表示する, **Then** マークダウンがレンダリングされた状態で表示される
4. **Given** タスクに詳細がある, **When** タスク一覧を表示する, **Then** タスク行に詳細ありを示すアイコンが表示される

---

### User Story 3 - マークダウン書式のサポート (Priority: P3)

ユーザーとして、一般的なマークダウン書式（見出し、リスト、リンク、太字、斜体、コードブロックなど）を使用して詳細を整理したい。

**Why this priority**: マークダウンの基本機能がサポートされていれば、ユーザーは柔軟に情報を整理できる。ただし、最初はシンプルな書式のみでも価値を提供できる。

**Independent Test**: 各マークダウン記法を入力し、プレビューで正しく表示されることを確認。

**Acceptance Scenarios**:

1. **Given** 詳細編集モードである, **When** 見出し記法（#）を入力する, **Then** プレビューで見出しとして表示される
2. **Given** 詳細編集モードである, **When** リスト記法（-、*、1.）を入力する, **Then** プレビューでリストとして表示される
3. **Given** 詳細編集モードである, **When** リンク記法（[text](url)）を入力する, **Then** プレビューでクリック可能なリンクとして表示される
4. **Given** 詳細編集モードである, **When** 強調記法（**太字**、*斜体*）を入力する, **Then** プレビューで正しく強調表示される
5. **Given** 詳細編集モードである, **When** コードブロック記法を入力する, **Then** プレビューでコードとして表示される

---

### Edge Cases

- **空の詳細**: 詳細が空の状態で保存した場合、空として保存される（プレースホルダーテキストは表示されるが、データとしては空）
- **非常に長い詳細**: 大量のテキストを入力した場合でも、正しく保存・表示される（パフォーマンス低下を最小限に抑える）
- **特殊文字**: HTML特殊文字（<, >, &）を含むテキストが正しくエスケープされ、XSS攻撃を防ぐ
- **マークダウン構文エラー**: 不正なマークダウン構文を入力した場合、クラッシュせずにそのまま表示される
- **編集中の離脱**: 詳細を編集中にページを離れようとした場合、未保存の変更がある旨を警告する
- **同時編集**: 同じタスクの他の属性（タイトル、完了状態など）を変更しても、詳細が失われない

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、各タスクに対してマークダウン形式の詳細テキストを保存できなければならない
- **FR-002**: システムは、詳細の編集時にテキストエリアを提供しなければならない
- **FR-003**: ユーザーは、詳細の編集モードとプレビューモードを切り替えられなければならない
- **FR-004**: システムは、マークダウンテキストをHTMLにレンダリングして表示できなければならない
- **FR-005**: システムは、詳細データをタスクの他の属性と共に永続化しなければならない
- **FR-006**: システムは、マークダウンレンダリング時にユーザー入力をサニタイズし、XSS攻撃を防止しなければならない
- **FR-007**: システムは、以下のマークダウン書式をサポートしなければならない：見出し、リスト（順序付き・順序なし）、リンク、太字、斜体、コードブロック、インラインコード
- **FR-008**: 詳細が空の場合、プレースホルダーまたはヒントテキストを表示しなければならない
- **FR-009**: 編集中に未保存の変更がある場合、ユーザーに視覚的なフィードバックを提供しなければならない

### Key Entities

- **TodoDescription（タスク詳細）**: タスクに紐づくマークダウン形式の詳細テキスト。主要属性：値（マークダウンテキスト）、最大文字数制限（10,000文字）
- **Todo（タスク）**: 既存のタスクエンティティに詳細フィールドを追加。詳細は任意項目（空でも可）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーは30秒以内にタスクの詳細を追加・編集できる
- **SC-002**: 保存された詳細は、ページリロード後も100%の確率で正しく復元される
- **SC-003**: 1000文字以上の詳細を含むタスクでも、表示に1秒以上かからない
- **SC-004**: サポートされているマークダウン書式（7種類）が100%正しくレンダリングされる
- **SC-005**: 詳細機能を使用したユーザーの90%が、最初の試行で詳細の追加・保存に成功する

## Assumptions

- ユーザーは基本的なマークダウン記法を理解している、または学習する意欲がある
- 詳細の文字数上限は10,000文字とする
- 詳細は単一のテキストフィールドとし、添付ファイルや画像の直接アップロードは含まない（リンクでの参照は可能）
- マークダウンのプレビューはリアルタイムではなく、明示的な切り替えで表示する

## Clarifications

### Session 2025-11-30

- Q: 詳細編集UIの表示位置はどこにすべきか？ → A: 詳細パネル／サイドバーに表示（タスク選択時にパネルが開く）
- Q: 詳細の保存タイミングはいつか？ → A: 明示的な保存ボタンをクリック時のみ保存
- Q: タスクリストで詳細の有無をどう示すか？ → A: 詳細がある場合は小さなアイコンをタスク行に表示
- Q: キーボードショートカットをサポートするか？ → A: ショートカットなし（すべてボタンクリックで操作）
- Q: 詳細の文字数上限は？ → A: 10,000文字を上限とする
