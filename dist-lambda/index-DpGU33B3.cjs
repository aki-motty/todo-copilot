"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const e=require("./index.lambda-Bk_mD_hS.cjs");exports.EventStreamSerde=class{marshaller;serializer;deserializer;serdeContext;defaultContentType;constructor({marshaller:e,serializer:t,deserializer:r,serdeContext:i,defaultContentType:n}){this.marshaller=e,this.serializer=t,this.deserializer=r,this.serdeContext=i,this.defaultContentType=n}async serializeEventStream({eventStream:e,requestSchema:t,initialRequest:r}){const i=this.marshaller,n=t.getEventStreamMember(),s=t.getMemberSchema(n),a=this.serializer,o=this.defaultContentType,l=Symbol("initialRequestMarker"),c={async*[Symbol.asyncIterator](){if(r){const e={":event-type":{type:"string",value:"initial-request"},":message-type":{type:"string",value:"event"},":content-type":{type:"string",value:o}};a.write(t,r);const i=a.flush();yield{[l]:!0,headers:e,body:i}}for await(const t of e)yield t}};return i.serialize(c,e=>{if(e[l])return{headers:e.headers,body:e.body};const t=Object.keys(e).find(e=>"__type"!==e)??"",{additionalHeaders:r,body:i,eventType:n,explicitPayloadContentType:a}=this.writeEventBody(t,s,e);return{headers:{":event-type":{type:"string",value:n},":message-type":{type:"string",value:"event"},":content-type":{type:"string",value:a??o},...r},body:i}})}async deserializeEventStream({response:t,responseSchema:r,initialResponseContainer:i}){const n=this.marshaller,s=r.getEventStreamMember(),a=r.getMemberSchema(s).getMemberSchemas(),o=Symbol("initialResponseMarker"),l=n.deserialize(t.body,async t=>{const i=Object.keys(t).find(e=>"__type"!==e)??"",n=t[i].body;if("initial-response"===i){const e=await this.deserializer.read(r,n);return delete e[s],{[o]:!0,...e}}if(i in a){const r=a[i];if(r.isStructSchema()){const s={};let a=!1;for(const[o,l]of r.structIterator()){const{eventHeader:r,eventPayload:c}=l.getMergedTraits();if(a=a||Boolean(r||c),c)l.isBlobSchema()?s[o]=n:l.isStringSchema()?s[o]=(this.serdeContext?.utf8Encoder??e.toUtf8)(n):l.isStructSchema()&&(s[o]=await this.deserializer.read(l,n));else if(r){const e=t[i].headers[o]?.value;null!=e&&(l.isNumericSchema()?s[o]=e&&"object"==typeof e&&"bytes"in e?BigInt(e.toString()):Number(e):s[o]=e)}}if(a)return{[i]:s}}return{[i]:await this.deserializer.read(r,n)}}return{$unknown:t}}),c=l[Symbol.asyncIterator](),d=await c.next();if(d.done)return l;if(d.value?.[o]){if(!r)throw new Error("@smithy::core/protocols - initial-response event encountered in event stream but no response schema given.");for(const[e,t]of Object.entries(d.value))i[e]=t}return{async*[Symbol.asyncIterator](){for(d?.value?.[o]||(yield d.value);;){const{done:e,value:t}=await c.next();if(e)break;yield t}}}}writeEventBody(t,r,i){const n=this.serializer;let s,a=t,o=null;const l={};if(r.getSchema()[4].includes(t)){const e=r.getMemberSchema(t);if(!e.isStructSchema())throw new Error("@smithy/core/event-streams - non-struct member not supported in event stream union.");for(const[r,n]of e.structIterator()){const{eventHeader:e,eventPayload:s}=n.getMergedTraits();if(s){o=r;break}if(e){const e=i[t][r];let s="binary";n.isNumericSchema()?s=(-2)**31<=e&&e<=2**31-1?"integer":"long":n.isTimestampSchema()?s="timestamp":n.isStringSchema()?s="string":n.isBooleanSchema()&&(s="boolean"),null!=e&&(l[r]={type:s,value:e},delete i[t][r])}}if(null!==o){const r=e.getMemberSchema(o);r.isBlobSchema()?s="application/octet-stream":r.isStringSchema()&&(s="text/plain"),n.write(r,i[t][o])}else n.write(e,i[t])}else{const[e,r]=i[t];a=e,n.write(15,r)}const c=n.flush();return{body:"string"==typeof c?(this.serdeContext?.utf8Decoder??e.fromUtf8)(c):c,eventType:a,explicitPayloadContentType:s,additionalHeaders:l}}};
//# sourceMappingURL=index-DpGU33B3.cjs.map
