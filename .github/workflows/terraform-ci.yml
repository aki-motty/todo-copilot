name: Terraform CI/CD

on:
  push:
    branches:
      - main
      - '**'
    paths:
      - 'src/**'
      - 'tests/**'
      - 'infrastructure/**'
      - '.github/workflows/terraform-ci.yml'
      - 'package.json'
      - 'vite.config.ts'
      - 'vite.config.lambda.ts'
      - 'tsconfig.json'
  pull_request:
    branches:
      - main
    paths:
      - 'src/**'
      - 'tests/**'
      - 'infrastructure/**'
      - '.github/workflows/terraform-ci.yml'
      - 'package.json'
      - 'vite.config.ts'
      - 'vite.config.lambda.ts'
      - 'tsconfig.json'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  AWS_REGION: ap-northeast-1
  TERRAFORM_VERSION: 1.5.0

jobs:
  terraform-validate:
    name: Terraform Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Terraform Format Check
        id: fmt
        working-directory: infrastructure/terraform
        run: |
          terraform fmt -check -recursive
          echo "✅ Format check passed"

      - name: Terraform Init (Backend disabled)
        id: init
        working-directory: infrastructure/terraform
        run: |
          terraform init -backend=false -upgrade

      - name: Terraform Validate
        id: validate
        working-directory: infrastructure/terraform
        run: |
          terraform validate
          echo "✅ Validation passed"

      - name: Comment PR with Plan Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const comment = `## Terraform Validation Results ✅

            ### Format Check
            - Status: ✅ Passed

            ### Validation
            - Status: ✅ Passed

            All Terraform configurations are valid and ready for deployment.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  tests:
    name: Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: terraform-validate
    if: github.event_name == 'pull_request'
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Terraform Module Tests
        run: npm test -- tests/integration/terraform-modules.spec.ts --coverage

      - name: Upload Test Coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
          flags: terraform
          name: terraform-coverage

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: terraform-validate
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Run TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: Init TFLint
        working-directory: infrastructure/terraform
        run: tflint --init

      - name: Run TFLint
        working-directory: infrastructure/terraform
        run: tflint --format compact

      - name: Checkov Security Scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: infrastructure/terraform
          framework: terraform
          output_format: sarif
          output_file_path: report.sarif

      - name: Upload Checkov Results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: report.sarif

  plan-summary:
    name: Generate Plan Summary
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [terraform-validate, tests]
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: infrastructure/terraform
        run: terraform init -backend=false

      - name: Generate Plan Summary
        working-directory: infrastructure/terraform
        id: summary
        run: |
          echo "# Terraform Plan Summary" > plan-summary.md
          echo "" >> plan-summary.md

          for env in dev staging prod; do
            echo "## Environment: $env" >> plan-summary.md
            terraform plan -var-file="environments/${env}.tfvars" -json | \
              jq -r '.resource_changes[] | "- \(.type).\(.name): \(.change.actions | join(", "))"' >> plan-summary.md 2>/dev/null || true
            echo "" >> plan-summary.md
          done

          cat plan-summary.md

      - name: Comment PR with Summary
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('infrastructure/terraform/plan-summary.md', 'utf8').substring(0, 30000);
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

  deploy-dev:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: terraform-validate
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    environment:
      name: develop
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME_DEV }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Lambda package
        run: npm run build:lambda

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Create Lambda ZIP
        run: |
          mkdir -p infrastructure/terraform/dist
          cd dist-lambda
          zip -r ../infrastructure/terraform/dist/index.zip .
          cd ../infrastructure/terraform
          pwd
          ls -lh dist/

      - name: Verify Lambda ZIP location
        working-directory: infrastructure/terraform
        run: |
          ls -la dist/
          unzip -t dist/index.zip

      - name: Terraform Init
        working-directory: infrastructure/terraform
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="key=main/terraform.tfstate" \
            -backend-config="dynamodb_table=${{ secrets.TF_LOCK_TABLE }}" \
            -backend-config="region=${{ env.AWS_REGION }}"

      - name: Terraform Apply
        working-directory: infrastructure/terraform
        run: |
          terraform apply -auto-approve \
            -var-file="environments/dev.tfvars"

      - name: Export Outputs
        id: outputs
        working-directory: infrastructure/terraform
        run: |
          terraform output -json > outputs.json
          cat outputs.json
          echo "::set-output name=status::success"

      - name: Build Frontend
        run: |
          API_URL=$(jq -r '.api_gateway_endpoint.value' infrastructure/terraform/outputs.json)
          echo "Building frontend with API_URL=$API_URL"
          VITE_API_URL=$API_URL npm run build

      - name: Deploy Frontend to S3
        run: |
          BUCKET_NAME=$(jq -r '.frontend_bucket_name.value' infrastructure/terraform/outputs.json)
          echo "Deploying to bucket: $BUCKET_NAME"
          aws s3 sync dist/ s3://$BUCKET_NAME --delete

      - name: Invalidate CloudFront Cache
        run: |
          DIST_ID=$(jq -r '.cloudfront_distribution_id.value' infrastructure/terraform/outputs.json)
          echo "Invalidating CloudFront distribution: $DIST_ID"
          aws cloudfront create-invalidation --distribution-id $DIST_ID --paths "/*"

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: terraform-validate
    if: (github.ref == 'refs/heads/main' && github.event_name == 'push' && contains(github.event.head_commit.message, '[deploy-staging]')) || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment:
      name: staging
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME_STAGING }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Lambda package
        run: npm run build:lambda

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Create Lambda ZIP
        run: |
          mkdir -p infrastructure/terraform/dist
          cd dist-lambda
          zip -r ../infrastructure/terraform/dist/index.zip .
          cd ../infrastructure/terraform
          pwd
          ls -lh dist/

      - name: Verify Lambda ZIP location
        working-directory: infrastructure/terraform
        run: |
          ls -la dist/
          unzip -t dist/index.zip

      - name: Terraform Init
        working-directory: infrastructure/terraform
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="key=staging/terraform.tfstate" \
            -backend-config="dynamodb_table=${{ secrets.TF_LOCK_TABLE }}" \
            -backend-config="region=${{ env.AWS_REGION }}"

      - name: Terraform Plan
        id: plan
        working-directory: infrastructure/terraform
        run: |
          terraform plan \
            -var-file="environments/staging.tfvars" \
            -out=tfplan

      - name: Terraform Apply
        working-directory: infrastructure/terraform
        run: |
          terraform apply tfplan

      - name: Export Outputs
        id: outputs
        working-directory: infrastructure/terraform
        run: |
          terraform output -json > outputs.json
          cat outputs.json

      - name: Build Frontend
        run: |
          API_URL=$(jq -r '.api_gateway_endpoint.value' infrastructure/terraform/outputs.json)
          echo "Building frontend with API_URL=$API_URL"
          VITE_API_URL=$API_URL npm run build

      - name: Deploy Frontend to S3
        run: |
          BUCKET_NAME=$(jq -r '.frontend_bucket_name.value' infrastructure/terraform/outputs.json)
          echo "Deploying to bucket: $BUCKET_NAME"
          aws s3 sync dist/ s3://$BUCKET_NAME --delete

      - name: Invalidate CloudFront Cache
        run: |
          DIST_ID=$(jq -r '.cloudfront_distribution_id.value' infrastructure/terraform/outputs.json)
          echo "Invalidating CloudFront distribution: $DIST_ID"
          aws cloudfront create-invalidation --distribution-id $DIST_ID --paths "/*"

  deploy-prod:
    name: Deploy to Prod
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: terraform-validate
    if: (github.ref == 'refs/heads/main' && github.event_name == 'push' && contains(github.event.head_commit.message, '[deploy-prod]')) || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod')
    environment:
      name: production
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME_PROD }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Lambda package
        run: npm run build:lambda

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Create Lambda ZIP
        run: |
          mkdir -p infrastructure/terraform/dist
          cd dist-lambda
          zip -r ../infrastructure/terraform/dist/index.zip .
          cd ../infrastructure/terraform
          pwd
          ls -lh dist/

      - name: Verify Lambda ZIP location
        working-directory: infrastructure/terraform
        run: |
          ls -la dist/
          unzip -t dist/index.zip

      - name: Terraform Init
        working-directory: infrastructure/terraform
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="key=prod/terraform.tfstate" \
            -backend-config="dynamodb_table=${{ secrets.TF_LOCK_TABLE }}" \
            -backend-config="region=${{ env.AWS_REGION }}"

      - name: Terraform Plan
        id: plan
        working-directory: infrastructure/terraform
        run: |
          terraform plan \
            -var-file="environments/prod.tfvars" \
            -out=tfplan

      - name: Terraform Apply
        working-directory: infrastructure/terraform
        run: |
          terraform apply tfplan

      - name: Export Outputs
        id: outputs
        working-directory: infrastructure/terraform
        run: |
          terraform output -json > outputs.json
          cat outputs.json

      - name: Build Frontend
        run: |
          API_URL=$(jq -r '.api_gateway_endpoint.value' infrastructure/terraform/outputs.json)
          echo "Building frontend with API_URL=$API_URL"
          VITE_API_URL=$API_URL npm run build

      - name: Deploy Frontend to S3
        run: |
          BUCKET_NAME=$(jq -r '.frontend_bucket_name.value' infrastructure/terraform/outputs.json)
          echo "Deploying to bucket: $BUCKET_NAME"
          aws s3 sync dist/ s3://$BUCKET_NAME --delete

      - name: Invalidate CloudFront Cache
        run: |
          DIST_ID=$(jq -r '.cloudfront_distribution_id.value' infrastructure/terraform/outputs.json)
          echo "Invalidating CloudFront distribution: $DIST_ID"
          aws cloudfront create-invalidation --distribution-id $DIST_ID --paths "/*"

      - name: Create Deployment Record
        run: |
          echo "Production deployment completed at $(date)" >> deployment-log.txt
          git add deployment-log.txt
          git commit -m "chore: log prod deployment"
          git push

  notify:
    name: Notify Deployment
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [plan-summary]
    if: always()
    permissions:
      contents: read

    steps:
      - name: Workflow Summary
        run: |
          echo "## GitHub Actions Workflow Completed ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Workflow Status" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run ID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. ✅ Terraform Validation" >> $GITHUB_STEP_SUMMARY
          echo "2. ⏳ Deploy to Dev (OIDC)" >> $GITHUB_STEP_SUMMARY
          echo "3. ⏳ Deploy to Staging" >> $GITHUB_STEP_SUMMARY
          echo "4. ⏳ Deploy to Prod" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "For detailed logs, visit: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY

