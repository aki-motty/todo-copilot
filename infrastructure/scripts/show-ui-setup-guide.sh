#!/bin/bash
# Interactive Setup Guide
# GitHub ç’°å¢ƒä¿è­·ãƒ«ãƒ¼ãƒ«è¨­å®šç”¨ã®ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚¤ã‚¹ãƒ†ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰

set -e

cat << 'EOF'

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘         ğŸ“‹ GitHub Environment Protection Rules - UI Setup Guide             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ GitHub UI ã§ã®è¨­å®šæ‰‹é †ã‚’è¡¨ç¤ºã™ã‚‹ã‚¬ã‚¤ãƒ‰ã§ã™ã€‚
æ‰‹å‹•ã§ GitHub UI ã‹ã‚‰ä»¥ä¸‹ã®è¨­å®šã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“Š è¨­å®šå†…å®¹ã‚µãƒãƒªãƒ¼:

ç’°å¢ƒ         ç§˜å¯†               ä¿è­·ãƒ«ãƒ¼ãƒ«          èª¬æ˜
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
develop      AWS_ROLE_*_DEV     ãªã—              å³åº§ã«ãƒ‡ãƒ—ãƒ­ã‚¤
staging      AWS_ROLE_*_STAGING 1 æ‰¿èª            QA ç¢ºèªå¾Œ
production   AWS_ROLE_*_PROD    2 æ‰¿èª            æœ¬ç•ªç’°å¢ƒãƒªãƒªãƒ¼ã‚¹

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ” ã‚¹ãƒ†ãƒƒãƒ— 1: GitHub ç§˜å¯†ã®ç™»éŒ²

GitHub ç§˜å¯†ãŒä»¥ä¸‹ã®ã¨ãŠã‚Šç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„:

ã‚³ãƒãƒ³ãƒ‰:
  gh secret list

æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›:
  AWS_REGION                  Updated YYYY-MM-DD
  AWS_ROLE_TO_ASSUME_DEV      Updated YYYY-MM-DD
  AWS_ROLE_TO_ASSUME_PROD     Updated YYYY-MM-DD
  AWS_ROLE_TO_ASSUME_STAGING  Updated YYYY-MM-DD
  TF_LOCK_TABLE               Updated YYYY-MM-DD
  TF_STATE_BUCKET             Updated YYYY-MM-DD

å…¨ã¦ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ã‚¹ãƒ†ãƒƒãƒ— 2 ã«é€²ã‚“ã§ãã ã•ã„ã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ–±ï¸  ã‚¹ãƒ†ãƒƒãƒ— 2: GitHub ç’°å¢ƒã‚’ä½œæˆ

ä»¥ä¸‹ã® URL ã«ã‚¢ã‚¯ã‚»ã‚¹:
  https://github.com/aki-motty/todo-copilot/settings/environments

ã¾ãŸã¯ GitHub UI ã‹ã‚‰:
  1. ãƒªãƒã‚¸ãƒˆãƒªã®ãƒšãƒ¼ã‚¸ â†’ Settings â†’ Environments

3 ã¤ã®ç’°å¢ƒã‚’ä½œæˆã—ã¦ãã ã•ã„:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2-1. develop ç’°å¢ƒ (ä¿è­·ãƒ«ãƒ¼ãƒ«ãªã—)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. "New environment" ã‚’ã‚¯ãƒªãƒƒã‚¯                                 â”‚
â”‚ 2. Name: "develop" ã¨å…¥åŠ›                                       â”‚
â”‚ 3. "Configure environment" ã‚’ã‚¯ãƒªãƒƒã‚¯                           â”‚
â”‚ 4. Protection rules ã¯è¨­å®šã—ãªã„ (ã‚¹ã‚­ãƒƒãƒ—)                    â”‚
â”‚ 5. "Save protection rules" ã‚’ã‚¯ãƒªãƒƒã‚¯                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2-2. staging ç’°å¢ƒ (1 æ‰¿èªãŒå¿…è¦)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. "New environment" ã‚’ã‚¯ãƒªãƒƒã‚¯                                 â”‚
â”‚ 2. Name: "staging" ã¨å…¥åŠ›                                       â”‚
â”‚ 3. "Configure environment" ã‚’ã‚¯ãƒªãƒƒã‚¯                           â”‚
â”‚ 4. Protection rules ã‚’è¨­å®š:                                    â”‚
â”‚    âœ“ Required reviewers ã«ãƒã‚§ãƒƒã‚¯                             â”‚
â”‚    âœ“ Minimum number of reviewers: 1                            â”‚
â”‚    âœ“ Restrict deployments to specific branches:                â”‚
â”‚      â˜‘ main ãƒ–ãƒ©ãƒ³ãƒã®ã¿                                       â”‚
â”‚ 5. "Save protection rules" ã‚’ã‚¯ãƒªãƒƒã‚¯                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2-3. production ç’°å¢ƒ (2 æ‰¿èªãŒå¿…è¦)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. "New environment" ã‚’ã‚¯ãƒªãƒƒã‚¯                                 â”‚
â”‚ 2. Name: "production" ã¨å…¥åŠ›                                    â”‚
â”‚ 3. "Configure environment" ã‚’ã‚¯ãƒªãƒƒã‚¯                           â”‚
â”‚ 4. Protection rules ã‚’è¨­å®š:                                    â”‚
â”‚    âœ“ Required reviewers ã«ãƒã‚§ãƒƒã‚¯                             â”‚
â”‚    âœ“ Minimum number of reviewers: 2                            â”‚
â”‚    âœ“ Restrict deployments to specific branches:                â”‚
â”‚      â˜‘ main ãƒ–ãƒ©ãƒ³ãƒã®ã¿                                       â”‚
â”‚    âœ“ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³) Deployment branches and environments:         â”‚
â”‚      è¤‡æ•°ã® Review teams ã‚’æŒ‡å®š                                â”‚
â”‚ 5. "Save protection rules" ã‚’ã‚¯ãƒªãƒƒã‚¯                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… ã‚¹ãƒ†ãƒƒãƒ— 3: è¨­å®šã‚’æ¤œè¨¼

è¨­å®šãŒå®Œäº†ã—ãŸã‚‰ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§æ¤œè¨¼ã—ã¦ãã ã•ã„:

æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰:
  gh environment list

æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›:
  develop
  staging
  production

Environment Protection Rules ã®ç¢ºèª:
  gh environment view <ç’°å¢ƒå>

ä¾‹:
  gh environment view develop
  gh environment view staging
  gh environment view production

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸš€ ã‚¹ãƒ†ãƒƒãƒ— 4: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ†ã‚¹ãƒˆ

ã™ã¹ã¦ã®è¨­å®šãŒå®Œäº†ã—ãŸã‚‰ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ:

```bash
# main ãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥
git push origin 003-github-actions-deploy

# ã¾ãŸã¯ Pull Request ã‚’ä½œæˆ
gh pr create --base main --head 003-github-actions-deploy \
  --title "feat: GitHub Actions AWS deployment automation" \
  --body "OIDC authentication and environment protection rules configured"
```

GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ (terraform-ci.yml) ãŒè‡ªå‹•çš„ã«ãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã¾ã™:

1. âœ… Validate stage: Terraform ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼
2. âœ… Test stage: Jest ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
3. âœ… Security-scan stage: TFLint ã¨ Checkov ã®å®Ÿè¡Œ
4. âœ… Deploy-dev stage: dev ç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ (è‡ªå‹•)
5. ğŸ”„ Deploy-staging stage: staging ç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ (1 æ‰¿èªå¾…ã¡)
6. ğŸ”„ Deploy-prod stage: production ç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ (2 æ‰¿èªå¾…ã¡)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“‹ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ãŸã‚‰ã€ä»¥ä¸‹ã‚’ãƒã‚§ãƒƒã‚¯:

GitHub CLI:
  [ ] gh auth status ã§èªè¨¼æ¸ˆã¿
  [ ] gh secret list ã§ç§˜å¯† 6 å€‹ãŒè¡¨ç¤º
  [ ] gh environment list ã§ç’°å¢ƒ 3 å€‹ãŒè¡¨ç¤º

GitHub UI:
  [ ] Settings â†’ Environments ã§ç’°å¢ƒãŒè¡¨ç¤º
  [ ] develop ã«ä¿è­·ãƒ«ãƒ¼ãƒ«ãªã—
  [ ] staging ã« 1 æ‰¿èªãŒå¿…è¦
  [ ] production ã« 2 æ‰¿èªãŒå¿…è¦

AWS:
  [ ] aws iam list-open-id-connect-providers ã§ OIDC ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ç¢ºèª
  [ ] aws iam get-role ã§ 3 ã¤ã®ãƒ­ãƒ¼ãƒ«ç¢ºèª

ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼:
  [ ] main ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã§ terraform-ci.yml ãŒå®Ÿè¡Œ
  [ ] dev ç’°å¢ƒãŒè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
  [ ] staging ãƒ‡ãƒ—ãƒ­ã‚¤ã« 1 æ‰¿èªãŒå¿…è¦
  [ ] production ãƒ‡ãƒ—ãƒ­ã‚¤ã« 2 æ‰¿èªãŒå¿…è¦

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ†˜ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

GitHub CLI ã§ç§˜å¯†ãŒè¡¨ç¤ºã•ã‚Œãªã„:
  1. gh auth status ã‚’å®Ÿè¡Œ
  2. gh auth logout â†’ gh auth login ã§å†èªè¨¼
  3. gh secret list ã‚’å†å®Ÿè¡Œ

ç’°å¢ƒãŒä½œæˆã§ããªã„:
  1. ãƒªãƒã‚¸ãƒˆãƒªæ‰€æœ‰è€…æ¨©é™ãŒã‚ã‚‹ã‹ç¢ºèª
  2. GitHub Organization ã®è¨­å®šã‚’ç¢ºèª
  3. Branch protection rules ã¨ Environment protection rules ã®ç›¸äº’ä½œç”¨ã‚’ç¢ºèª

OIDC ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆã‚¨ãƒ©ãƒ¼:
  1. infrastructure/docs/OIDC_TROUBLESHOOTING.md ã‚’å‚ç…§
  2. ./tests/integration/test-oidc-auth.sh ã§è¨ºæ–­

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“š å‚è€ƒè³‡æ–™

- è‡ªå‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ: infrastructure/scripts/setup-github-env.sh
- ç§˜å¯†ãƒ»ç’°å¢ƒãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: infrastructure/docs/SECRETS_AND_ENVIRONMENTS.md
- ç’°å¢ƒä¿è­·ãƒ«ãƒ¼ãƒ«: infrastructure/docs/ENVIRONMENT_PROTECTION.md
- OIDC ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°: infrastructure/docs/OIDC_TROUBLESHOOTING.md
- å®Ÿè£…å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ: specs/003-github-actions-deploy/tasks.md

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… Setup Guide ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸã€‚

ä¸Šè¨˜ã®æ‰‹é †ã«å¾“ã£ã¦ GitHub UI ã‹ã‚‰ç’°å¢ƒä¿è­·ãƒ«ãƒ¼ãƒ«è¨­å®šã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ã€‚

EOF
